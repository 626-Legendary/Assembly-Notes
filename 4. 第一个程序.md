# 📘 8086 汇编入门 —— 第一个程序（整理·订正版）

---

## 4.1 一个源程序从写出到执行的过程

### 4.1.1 汇编程序从编写到执行的整体流程

一个汇编语言程序从写出到最终执行的简要过程为：

> **编写 → 汇编 → 连接 → 执行**

说明：

1. **编写**
   编写源程序文件（`.asm`），内容是汇编指令、伪指令、宏指令等。

2. **汇编（编译）**
   使用汇编程序（`MASM.EXE`）将源程序翻译成 **目标文件**（`.obj`）。

3. **连接**
   使用连接程序（`LINK.EXE`）将一个或多个 `.obj` 文件处理为
   **可直接运行的可执行文件**（`.exe`）。

4. **执行**
   在操作系统（如 DOS）中运行 `.exe` 文件。

---

### 4.1.2 编译与连接的具体作用

#### （1）汇编（MASM）

* 输入：源程序 `.asm`
* 输出：目标文件 `.obj`
* 功能：

  * 将**汇编指令**翻译成机器码
  * 处理**伪指令**
  * 生成尚未完全可执行的中间结果

#### （2）连接（LINK）

* 输入：一个或多个 `.obj`
* 输出：`.exe`
* 功能：

  * 组合多个目标文件
  * 处理段地址、入口地址等信息
  * 生成操作系统可加载的程序

---

### 4.1.3 可执行文件的内容

一个 `.exe` 文件主要包含两部分：

1. **程序与数据**

   * 由汇编指令翻译而来的机器码
   * 源程序中定义的数据

2. **描述信息**

   * 程序大小
   * 占用内存信息
   * 程序入口地址等

---

### 4.1.4 执行可执行文件的过程（★重要）

当在 DOS 中执行一个可执行文件时：

1. 操作系统（或 shell）读取 `.exe`
2. 将机器码和数据装入内存
3. 进行必要初始化：

   * 分配内存
   * 设置段寄存器
   * **设置 CS:IP 指向程序入口**
4. CPU 开始执行程序

---

## 4.2 源程序的主要结构

### 4.2.1 源程序的组成

源程序由三类内容组成：

* **汇编指令**：
  → 会被翻译为机器码，由 CPU 执行
* **伪指令**：
  → 只给汇编器用，不生成机器码
* **宏指令**：
  → 编译阶段展开

---

### 4.2.2 伪指令（Pseudo Instructions）

特点：

1. **没有对应的机器码**
2. **不能由 CPU 直接执行**
3. 由**汇编器**在编译阶段处理
4. 用于指导汇编器如何生成程序结构

---

### 4.2.3 `segment` 和 `ends` —— 定义段（★核心）

* `segment` 和 `ends` 必须 **成对出现**
* 用于定义一个逻辑段

格式：

```asm
段名 segment
    ...
段名 ends
```

说明：

1. 段必须有名字
2. 一个程序可以包含多个段
3. 常见用途：

   * 代码段
   * 数据段
   * 栈段
4. **至少要有一个段用于存放代码**

---

### 4.2.4 `end` —— 程序的真正结束（⚠️极易混）

作用：

1. 标记**整个源程序的结束**
2. 汇编器遇到 `end` 后停止编译

⚠️ 切记区分：

| 指令     | 含义      |
| ------ | ------- |
| `ends` | 一个段的结束  |
| `end`  | 整个程序的结束 |

---

### 4.2.5 `assume` —— 段寄存器的“假设说明”（★重点）

作用：

* 告诉**汇编器**：
  某个段寄存器“应当”指向哪个段

示例：

```asm
assume cs:code, ds:data
```

说明：

* `assume` **不生成机器码**
* **不自动设置段寄存器**
* 只是为了让汇编器在检查代码时知道：

  * 某个内存访问是否合法

---

### 4.2.6 程序 与 源程序（概念区分）

* **源程序**：
  `.asm` 文件中的全部内容
* **程序**：
  最终由 CPU 执行的机器码和数据

关系：

> 程序最初以汇编指令形式存在于源程序中，
> 经汇编、连接后变为机器码，存入可执行文件。

---

### 4.2.7 标号 与 段名的区别（⚠️概念易混）

* **标号（label）**

  * 表示某条指令或数据的**地址**
* **段名**

  * 定义一个逻辑段
  * 最终对应一个**段地址**

⚠️ 纠正一点你的原文表述：

> ❌「一个标号指代了一个地址，即是段名称」
> ✅ 标号 ≠ 段名，它们层级不同

---

### 4.2.8 DOS 中的程序运行特点

1. DOS 是 **单任务操作系统**
2. 同一时刻只能运行一个程序
3. 一个程序结束后：

   * 必须将 CPU 控制权交还给调用它的程序
   * 这一过程称为 **程序返回**

---

### 4.2.9 程序返回（★非常重要）

标准写法：

```asm
mov ax, 4c00h
int 21h
```

含义：

* `4Ch`：DOS 的“程序结束”功能号
* `int 21h`：DOS 中断调用接口

⚠️ 注释修正：

> **中断机制是 DOS 的核心机制之一**
> Windows 的“消息机制”并不是 CPU 中断的直接替代，而是更高层的软件模型

---

### 4.2.10 与“结束”相关的三种概念（★必考）

| 类型   | 实现方式   | 作用              |
| ---- | ------ | --------------- |
| 段结束  | `ends` | 通知汇编器一个段结束      |
| 程序结束 | `end`  | 通知汇编器程序结束       |
| 程序返回 | 汇编指令   | 将 CPU 控制权交还 DOS |

---

### 4.2.11 语法错误 与 逻辑错误

#### 1️⃣ 语法错误

* 编译阶段发现
* 汇编器直接报错
* 容易定位

#### 2️⃣ 逻辑错误

* 编译能通过
* 运行时出错
* 不易发现（需调试）

---

## 4.3 简化的汇编与连接方式

* 传统方式：

  * 汇编：`masm.exe`
  * 连接：`link.exe`
* 简化工具：

  * `ml.exe`
    → 可在一次命令中完成汇编 + 连接

⚠️ 说明：
`ml.exe` 属于 **后期 MASM 工具**，8086 学习阶段主要还是用 `masm + link`

---

## 4.4 连接程序（LINK）的作用

连接程序的作用包括：

1. 将多个源程序分别汇编后生成的目标文件连接成一个可执行文件
2. 将目标文件与库文件连接
3. 处理目标文件中尚未确定的地址信息

⚠️ 重要结论：

> 即使只有一个 `.asm` 文件，
> **也必须经过连接才能生成可执行文件**

---

## 4.5 程序装入内存并运行的原理（★核心）

### 4.5.1 程序是如何被启动的？

1. 在 DOS 中运行程序 P1
2. 必须有一个**正在运行的程序 P2**
3. P2 负责：

   * 将 P1 装入内存
   * 将 CPU 控制权交给 P1

---

### 4.5.2 操作系统的外壳（Shell）

* 操作系统是复杂的软件系统
* 提供一个 **Shell（外壳）** 供用户操作

DOS 中：

* `command.com` 是 DOS 的 shell
* 又称 **命令解释器**

---

### 4.5.3 执行 `1.exe` 的全过程（★）

当在 DOS 中执行 `1.exe`：

1. **是谁启动了它？**
   → `command.com`
2. **如何开始执行？**
   → 设置 CS:IP 指向程序入口
3. **结束后回到哪里？**
   → 返回 `command.com`

---